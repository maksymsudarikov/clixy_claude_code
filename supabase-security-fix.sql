-- ============================================
-- CLIXY SUPABASE SECURITY FIX
-- –î–∞—Ç–∞: 2025-12-07
-- –¶–µ–ª—å: –ó–∞–∫—Ä—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–π –¥–æ—Å—Ç—É–ø –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
-- ============================================

-- –®–ê–ì 1: –£–¥–∞–ª—è–µ–º –ù–ï–ë–ï–ó–û–ü–ê–°–ù–´–ï –ø–æ–ª–∏—Ç–∏–∫–∏
-- –≠—Ç–∏ –ø–æ–ª–∏—Ç–∏–∫–∏ –ø–æ–∑–≤–æ–ª—è–ª–∏ –í–°–ï–ú —á–∏—Ç–∞—Ç—å –∏ –ø–∏—Å–∞—Ç—å –≤ –±–∞–∑—É
-- ============================================

DROP POLICY IF EXISTS "Enable read access for all users" ON shoots;
DROP POLICY IF EXISTS "Enable all operations for all users" ON shoots;
DROP POLICY IF EXISTS "Enable read for all users" ON gift_cards;
DROP POLICY IF EXISTS "Enable insert for all users" ON gift_cards;
DROP POLICY IF EXISTS "Enable update for all users" ON gift_cards;

-- –®–ê–ì 2: –°–æ–∑–¥–∞–µ–º –ë–ï–ó–û–ü–ê–°–ù–´–ï –ø–æ–ª–∏—Ç–∏–∫–∏
-- ============================================

-- –¢–ê–ë–õ–ò–¶–ê: shoots
-- –õ–æ–≥–∏–∫–∞: –í–°–ï –º–æ–≥—É—Ç —á–∏—Ç–∞—Ç—å (–ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ)
--         –ù–ò–ö–¢–û –Ω–µ –º–æ–∂–µ—Ç –ø–∏—Å–∞—Ç—å/—É–¥–∞–ª—è—Ç—å (–∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞/–≤–∞–Ω–¥–∞–ª–∏–∑–º–∞)
-- ============================================

CREATE POLICY "Public can view shoots" ON shoots
  FOR SELECT
  USING (true);

-- –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è shoots –∏—Å–ø–æ–ª—å–∑—É–π
-- Supabase Dashboard –∏–ª–∏ —Å–æ–∑–¥–∞–π –æ—Ç–¥–µ–ª—å–Ω—ã–π admin API endpoint


-- –¢–ê–ë–õ–ò–¶–ê: gift_cards
-- –õ–æ–≥–∏–∫–∞: –í–°–ï –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ gift cards (—Ñ–æ—Ä–º–∞ –Ω–∞ —Å–∞–π—Ç–µ)
--         –ù–ò–ö–¢–û –Ω–µ –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å —á—É–∂–∏–µ gift cards
--         –ù–ò–ö–¢–û –Ω–µ –º–æ–∂–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å/—É–¥–∞–ª—è—Ç—å (–∑–∞—â–∏—Ç–∞ –æ—Ç –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞)
-- ============================================

-- –†–∞–∑—Ä–µ—à–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö gift cards
CREATE POLICY "Anyone can create gift cards" ON gift_cards
  FOR INSERT
  WITH CHECK (true);

-- –†–∞–∑—Ä–µ—à–∏—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä –¢–û–õ–¨–ö–û —Å–≤–æ–∏—Ö gift cards (–ø–æ email)
-- –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –≠—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω —á–µ—Ä–µ–∑ Supabase Auth
-- –°–µ–π—á–∞—Å —É –Ω–∞—Å –Ω–µ—Ç auth, –ø–æ—ç—Ç–æ–º—É —ç—Ç–∞ –ø–æ–ª–∏—Ç–∏–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç –í–°–ï —á—Ç–µ–Ω–∏—è
CREATE POLICY "Users can view own gift cards" ON gift_cards
  FOR SELECT
  USING (
    auth.email() = purchaser_email OR
    auth.email() = recipient_email
  );

-- ============================================
-- –í–ê–ñ–ù–û: –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–≥–æ SQL
-- ============================================
--
-- ‚úÖ –ß–¢–û –ë–£–î–ï–¢ –†–ê–ë–û–¢–ê–¢–¨:
-- - –ö–ª–∏–µ–Ω—Ç—ã —Å–º–æ–≥—É—Ç –ø–æ–∫—É–ø–∞—Ç—å gift cards (—Ñ–æ—Ä–º–∞ –Ω–∞ —Å–∞–π—Ç–µ)
-- - –í—Å–µ —Å–º–æ–≥—É—Ç –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ (shoots)
--
-- ‚ùå –ß–¢–û –ü–ï–†–ï–°–¢–ê–ù–ï–¢ –†–ê–ë–û–¢–ê–¢–¨:
-- - –°—Ç—Ä–∞–Ω–∏—Ü–∞ —É—Å–ø–µ—Ö–∞ gift card (–Ω–µ —Å–º–æ–∂–µ—Ç –ø—Ä–æ—á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ)
-- - –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å (–Ω–µ —Å–º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å shoots)
--
-- üí° –†–ï–®–ï–ù–ò–ï:
-- –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ gift cards –Ω—É–∂–Ω–æ:
-- 1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å service_role –∫–ª—é—á –Ω–∞ backend
-- 2. –ò–ª–∏ —Å–æ–∑–¥–∞—Ç—å Edge Function –≤ Supabase
-- 3. –ò–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å Supabase Auth
--
-- –î–ª—è –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏ –Ω—É–∂–Ω–æ:
-- 1. –î–æ–±–∞–≤–∏—Ç—å Supabase Auth
-- 2. –°–æ–∑–¥–∞—Ç—å –ø–æ–ª–∏—Ç–∏–∫—É –¥–ª—è authenticated users
-- ============================================


-- ============================================
-- –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–´–ô –í–ê–†–ò–ê–ù–¢ (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞ gift card success —Å—Ç—Ä–∞–Ω–∏—Ü–∞)
-- ============================================
-- –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —á—Ç–æ–±—ã success —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–∞–±–æ—Ç–∞–ª–∞ –ë–ï–ó –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏,
-- —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π —ç—Ç–æ (—É–¥–∞–ª–∏ -- –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫):

-- DROP POLICY IF EXISTS "Users can view own gift cards" ON gift_cards;

-- CREATE POLICY "Anyone can view gift cards" ON gift_cards
--   FOR SELECT
--   USING (true);

-- ‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –í–°–ï–ú —á–∏—Ç–∞—Ç—å –í–°–ï gift cards!
-- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ –µ—Å–ª–∏ –≤ gift cards –µ—Å—Ç—å –ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (email, —Ç–µ–ª–µ—Ñ–æ–Ω)
-- ============================================


-- ============================================
-- –ü–†–û–í–ï–†–ö–ê: –£–±–µ–¥–∏—Å—å —á—Ç–æ –ø–æ–ª–∏—Ç–∏–∫–∏ –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å
-- ============================================
SELECT
  schemaname,
  tablename,
  policyname,
  permissive,
  roles,
  cmd,
  qual
FROM pg_policies
WHERE tablename IN ('shoots', 'gift_cards')
ORDER BY tablename, policyname;

-- –î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏:
-- - "Public can view shoots"
-- - "Anyone can create gift cards"
-- - "Users can view own gift cards" (–∏–ª–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—É—é)
-- ============================================
